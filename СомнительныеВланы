Данная настройка влан сегментов на HQ-SW максимально НЕ ПРОВЕРЕННАЯ СОМНИТЕЛЬНАЯ И НАПИСАННАЯ ДИПСИКОМ ЗА ДВЕ МИНУТЫ
ПРОШУ ПЕРЕД ЭТИМ СДЕЛАТЬ СНАПШОТ СЛЕДУЮЩИХ МАШИН
HQ-RTR 
HQ-SW
HQ-CLI
HQ-SRV

ВЫ САМИ НЕСЕТЕ ОТВЕТСТВЕННОСТЬ ЗА РАБОТОСПОСОБНОСТЬ СЛЕДУЮЩЕГО ВЫСЕРА ДИПСИКА

1. Настройка HQ-Switch (коммутатор)
1.1. Активация модуля 8021q

# Загрузите модуль VLAN
sudo modprobe 8021q

# Добавьте модуль в автозагрузку
echo "8021q" | sudo tee /etc/modules-load.d/vlan.conf

1.2. Создание VLAN-интерфейсов через nmcli (NetworkManager)

# Создайте VLAN-интерфейсы
sudo nmcli con add type vlan con-name eth0.100 dev eth0 id 100
sudo nmcli con add type vlan con-name eth0.200 dev eth0 id 200
sudo nmcli con add type vlan con-name eth0.999 dev eth0 id 999

# Запустите интерфейсы
sudo nmcli con up eth0.100
sudo nmcli con up eth0.200
sudo nmcli con up eth0.999

1.3. Настройка портов через bridge
Убедитесь, что установлен пакет bridge-utils:


sudo dnf install bridge-utils -y

Транк-порт (ПОРТ ОТ RTR К СВИТЧУ):

sudo ip link set ИНТЕРФЕЙС up
sudo bridge vlan add vid 100,200,999 dev ИНТЕРФЕЙС

Аксесс-порты (ИНТЕРФЕЙС1 ТАМ ГДЕ ДОЛЖЕН БЫТЬ VLAN100 ИНТЕРФЕС2 ТАМ ГДЕ VLAN200):

# Для  (VLAN100)
sudo ip link set eth1 up
sudo bridge vlan add vid 100 dev ИНТЕРФЕЙС1 pvid untagged
sudo bridge vlan del vid 1 dev ИНТЕРФЕЙС1

# Для  (VLAN200)
sudo ip link set eth2 up
sudo bridge vlan add vid 200 dev ИНТЕРФЕЙС2 pvid untagged
sudo bridge vlan del vid 1 dev ИНТЕРФЕЙС2

1.4. Сохранение настроек портов
Создайте systemd-юнит для автоматической настройки при загрузке:

sudo nano /etc/systemd/system/setup-vlan-ports.service
Добавьте ОТ СЮДА:

[Unit]
Description=Configure VLAN Ports
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/sbin/bridge vlan add vid 100,200,999 dev ИНТЕРФЕЙС ОТ RTR К СВИТЧЦ
ExecStart=/usr/sbin/bridge vlan add vid 100 dev НТЕРФЕЙС1 ТАМ ГДЕ ДОЛЖЕН БЫТЬ VLAN100 pvid untagged
ExecStart=/usr/sbin/bridge vlan del vid 1 dev НТЕРФЕЙС1 ТАМ ГДЕ ДОЛЖЕН БЫТЬ VLAN100
ExecStart=/usr/sbin/bridge vlan add vid 200 dev ИНТЕРФЕС2 ТАМ ГДЕ VLAN200 pvid untagged
ExecStart=/usr/sbin/bridge vlan del vid 1 dev ИНТЕРФЕС2 ТАМ ГДЕ VLAN200

[Install]
WantedBy=multi-user.target
ДО СЮДА


Активируйте службу:
sudo systemctl enable setup-vlan-ports.service


2. Настройка HQ-RTR (роутер)
2.1. Создание VLAN-интерфейсов через NetworkManager
bash
# Создайте сабинтерфейсы
sudo nmcli con add type vlan con-name ИНТЕРФЕЙС К СВИТЧУ.100 dev eth1 id 100
sudo nmcli con add type vlan con-name ИНТЕРФЕЙС К СВИТЧУ.200 dev eth1 id 200
sudo nmcli con add type vlan con-name ИНТЕРФЕЙС К СВИТЧУ.999 dev eth1 id 999

# Назначьте IP-адреса
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ.100 ipv4.addresses СВОИ АПИШНИК ДЛЯ VLAN100 С МАСКОЙ ЧЕРЕЗ / 
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ.200 ipv4.addresses СВОИ АПИШНИК ДЛЯ VLAN200  С МАСКОЙ ЧЕРЕЗ /
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ.999 ipv4.addresses СВОИ АПИШНИК ДЛЯ VLAN999  С МАСКОЙ ЧЕРЕЗ /

# Включите интерфейсы
sudo nmcli con up ИНТЕРФЕЙС К СВИТЧУ.100
sudo nmcli con up ИНТЕРФЕЙС К СВИТЧУ.200
sudo nmcli con up ИНТЕРФЕЙС К СВИТЧУ.999


3. Настройка серверов (HQ-SRV и HQ-CLI)
3.1. HQ-SRV (VLAN100)

sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ ipv4.addresses АДРЕСС УСТРОЙСТВА С МАСКОЙ ЧЕРЕЗ /
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ ipv4.gateway ШЛЮЗ
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ ipv4.method manual
sudo nmcli con up ИНТЕРФЕЙС К СВИТЧУ

3.2. HQ-CLI (VLAN200)
bash
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ ipv4.addresses АДРЕСС УСТРОЙСТВА С МАСКОЙ ЧЕРЕЗ /
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ ipv4.gateway ШЛЮЗ
sudo nmcli con mod ИНТЕРФЕЙС К СВИТЧУ ipv4.method manual
sudo nmcli con up ИНТЕРФЕЙС К СВИТЧУ

4. Проверка
После перезагрузки выполните:

bash
# Проверьте VLAN-интерфейсы
ip link show

# Убедитесь в наличии маршрутов
ip route

# Проверьте связность
ping (с HQ-SRV) до ШЛЮЗА



